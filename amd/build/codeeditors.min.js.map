{"version":3,"file":"codeeditors.min.js","sources":["../src/codeeditors.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Provides utility methods to setup resizable ace editors into a page.\n * @copyright  Astor Bizard, 2019\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* globals ace */\ndefine(['jquery', 'core/url'], function($, url) {\n\n    // Global Ace editor theme to use for all editors.\n    var aceTheme;\n\n    /**\n     * Setup each specified textarea with Ace editor, with a vertical resize feature.\n     * It inherits readonly attribute from textarea.\n     * @param {jQuery} $textareas JQuery set of textareas from which to set up editors.\n     * @param {String} aceSize Initial CSS size of editors.\n     * @param {String} aceLang (optional) Lang (mode) to setup editors from.\n     * @return {Editor} The last editor set up.\n     */\n    function setupAceEditors($textareas, aceSize, aceLang) {\n        var aceEditor;\n\n        // Vertical resizing.\n        var prevY;\n        var $placeholderBeingResized = null;\n\n        if (aceLang === undefined) {\n            aceLang = 'plain_text';\n        }\n\n        $textareas.each(function() {\n            var $textarea = $(this);\n            var $editorPlaceholder = $('<div>', {\n                width: '100%',\n                height: aceSize,\n                'id': 'ace_placeholder_' + $textarea.attr('name'),\n                'class': 'ace-placeholder'\n            }).insertAfter($textarea);\n            $textarea.hide();\n\n            $('<div>', {\n                'id': 'ace_resize_' + $textarea.attr('name'),\n                'class': 'ace-resize'\n            }).insertAfter($editorPlaceholder)\n            .mousedown(function(event) {\n                prevY = event.clientY;\n                $placeholderBeingResized = $editorPlaceholder;\n                event.preventDefault();\n            });\n\n            ace.config.set('modePath', url.relativeUrl(\"/mod/vpl/editor/ace9\"));\n            ace.config.set('themePath', url.relativeUrl(\"/mod/vpl/editor/ace9\"));\n\n            // This is what creates the Ace editor within the placeholder div.\n            aceEditor = ace.edit($editorPlaceholder[0]);\n            aceEditor.setOptions({\n                theme: 'ace/theme/' + aceTheme,\n                mode: 'ace/mode/' + aceLang\n            });\n            aceEditor.$blockScrolling = Infinity; // Disable ace warning.\n            aceEditor.getSession().setValue($textarea.val());\n            aceEditor.setReadOnly($textarea.is('[readonly]'));\n\n            // On submit or run/check, propagate the changes to textarea.\n            $('input[type=submit], .qvpl-buttons button').click(function() {\n                // Cannot use aceEditor here, as it will have another value later.\n                $textarea.val(ace.edit('ace_placeholder_' + $textarea.attr('name')).getValue());\n            });\n        });\n\n        $(window).mousemove(function(event) {\n            if ($placeholderBeingResized) {\n                $placeholderBeingResized.height(function(i, height) {\n                    return height + event.clientY - prevY;\n                });\n                prevY = event.clientY;\n                ace.edit($placeholderBeingResized[0]).resize();\n                event.preventDefault();\n            }\n        }).mouseup(function() {\n            $placeholderBeingResized = null;\n        });\n\n        return aceEditor;\n    }\n\n    /**\n     * Loads Ace script from VPL plugin.\n     * @return {Promise} A promise that resolves upon load.\n     */\n    function loadAce() {\n        if (typeof ace != 'undefined') {\n            return $.Deferred().resolve();\n        }\n        var ACESCRIPTLOCATION = url.relativeUrl(\"/mod/vpl/editor/ace9\");\n        return $.ajax({\n            url: ACESCRIPTLOCATION + '/ace.js',\n            dataType: 'script',\n            cache: true,\n            success: function() {\n                ace.config.set('basePath', ACESCRIPTLOCATION);\n            }\n        });\n    }\n\n    return {\n        // Setup editors in question edition form.\n        setupFormEditors: function(theme, callback) {\n            aceTheme = theme;\n            loadAce().done(function() {\n                setupAceEditors($('.code-editor textarea'), '170px');\n                callback();\n            });\n        },\n\n        // Setup editor in answer form.\n        setupQuestionEditor: function(theme, $textarea, $setTextButtons, lineOffset, callback) {\n            aceTheme = theme;\n            loadAce().done(function() {\n                console.log('TEXTAREA');\n                console.log($textarea);\n                // Setup question editor.\n                var aceEditor = setupAceEditors($textarea, '200px', $textarea.data('templatelang'));\n                // Set first line number to match compilation messages.\n                aceEditor.setOption('firstLineNumber', lineOffset);\n                // Setup reset and correction buttons (if present, ie. not review mode).\n                $setTextButtons.each(function() {\n                    var text = $(this).data('text');\n                    $(this).removeAttr('data-text');\n                    $(this).click(function(event) {\n                        if (aceEditor.getValue() != text) {\n                            aceEditor.setValue(text);\n                        }\n                        event.preventDefault();\n                    });\n                });\n                callback();\n            });\n        }\n    };\n});"],"names":["define","$","url","aceTheme","setupAceEditors","$textareas","aceSize","aceLang","aceEditor","prevY","$placeholderBeingResized","undefined","each","$textarea","this","$editorPlaceholder","width","height","attr","insertAfter","hide","mousedown","event","clientY","preventDefault","ace","config","set","relativeUrl","edit","setOptions","theme","mode","$blockScrolling","Infinity","getSession","setValue","val","setReadOnly","is","click","getValue","window","mousemove","i","resize","mouseup","loadAce","Deferred","resolve","ACESCRIPTLOCATION","ajax","dataType","cache","success","setupFormEditors","callback","done","setupQuestionEditor","$setTextButtons","lineOffset","console","log","data","setOption","text","removeAttr"],"mappings":";;;;;AAsBAA,iCAAO,CAAC,SAAU,aAAa,SAASC,EAAGC,SAGnCC,kBAUKC,gBAAgBC,WAAYC,QAASC,aACtCC,UAGAC,MACAC,yBAA2B,iBAEfC,IAAZJ,UACAA,QAAU,cAGdF,WAAWO,MAAK,eACRC,UAAYZ,EAAEa,MACdC,mBAAqBd,EAAE,QAAS,CAChCe,MAAO,OACPC,OAAQX,WACF,mBAAqBO,UAAUK,KAAK,cACjC,oBACVC,YAAYN,WACfA,UAAUO,OAEVnB,EAAE,QAAS,IACD,cAAgBY,UAAUK,KAAK,cAC5B,eACVC,YAAYJ,oBACdM,WAAU,SAASC,OAChBb,MAAQa,MAAMC,QACdb,yBAA2BK,mBAC3BO,MAAME,oBAGVC,IAAIC,OAAOC,IAAI,WAAYzB,IAAI0B,YAAY,yBAC3CH,IAAIC,OAAOC,IAAI,YAAazB,IAAI0B,YAAY,0BAG5CpB,UAAYiB,IAAII,KAAKd,mBAAmB,KAC9Be,WAAW,CACjBC,MAAO,aAAe5B,SACtB6B,KAAM,YAAczB,UAExBC,UAAUyB,gBAAkBC,EAAAA,EAC5B1B,UAAU2B,aAAaC,SAASvB,UAAUwB,OAC1C7B,UAAU8B,YAAYzB,UAAU0B,GAAG,eAGnCtC,EAAE,4CAA4CuC,OAAM,WAEhD3B,UAAUwB,IAAIZ,IAAII,KAAK,mBAAqBhB,UAAUK,KAAK,SAASuB,kBAI5ExC,EAAEyC,QAAQC,WAAU,SAASrB,OACrBZ,2BACAA,yBAAyBO,QAAO,SAAS2B,EAAG3B,eACjCA,OAASK,MAAMC,QAAUd,SAEpCA,MAAQa,MAAMC,QACdE,IAAII,KAAKnB,yBAAyB,IAAImC,SACtCvB,MAAME,qBAEXsB,SAAQ,WACPpC,yBAA2B,QAGxBF,mBAOFuC,aACa,oBAAPtB,WACAxB,EAAE+C,WAAWC,cAEpBC,kBAAoBhD,IAAI0B,YAAY,+BACjC3B,EAAEkD,KAAK,CACVjD,IAAKgD,kBAAoB,UACzBE,SAAU,SACVC,OAAO,EACPC,QAAS,WACL7B,IAAIC,OAAOC,IAAI,WAAYuB,4BAKhC,CAEHK,iBAAkB,SAASxB,MAAOyB,UAC9BrD,SAAW4B,MACXgB,UAAUU,MAAK,WACXrD,gBAAgBH,EAAE,yBAA0B,SAC5CuD,eAKRE,oBAAqB,SAAS3B,MAAOlB,UAAW8C,gBAAiBC,WAAYJ,UACzErD,SAAW4B,MACXgB,UAAUU,MAAK,WACXI,QAAQC,IAAI,YACZD,QAAQC,IAAIjD,eAERL,UAAYJ,gBAAgBS,UAAW,QAASA,UAAUkD,KAAK,iBAEnEvD,UAAUwD,UAAU,kBAAmBJ,YAEvCD,gBAAgB/C,MAAK,eACbqD,KAAOhE,EAAEa,MAAMiD,KAAK,QACxB9D,EAAEa,MAAMoD,WAAW,aACnBjE,EAAEa,MAAM0B,OAAM,SAASlB,OACfd,UAAUiC,YAAcwB,MACxBzD,UAAU4B,SAAS6B,MAEvB3C,MAAME,uBAGdgC"}