/**
 * Defines the behavior of the student's answer form for a savpl.
 * @copyright  Astor Bizard, 2019
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("qtype_savpl/studentanswer",["jquery","qtype_savpl/codeeditors","qtype_savpl/vplservice","qtype_savpl/scriptsloader"],(function($,CodeEditors,VPLService,ScriptsLoader){function str(key){switch(key){case"console":return"[Process";case"connected":case"connecting":case"running":return"running]";case"connection_closed":return"exited]";default:return key}}function makeResultHtml(result,field,level){if(result[field]){var formattedText="";return(text=result[field],map={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"},text.replace(/[&<>"']/g,(function(c){return map[c]}))).split("\n").forEach((function(line){"-"==line.charAt(0)&&(line='<span class="vpl-test-title font-italic rounded px-1">'+line+"</span>"),formattedText+=line+"\n"})),'<span class="vpl-result-title vpl-title-'+level+' d-block font-weight-bold border border-dark pl-1 mb-1">'+M.util.get_string(field,"qtype_savpl")+"</span>"+formattedText.trim()}var text,map;return""}function displayResult(displayId,result){var $display=$("#"+displayId);null===result&&(result=$display.data("result"));var html=makeResultHtml(result,"compilation","error")+makeResultHtml(result,"evaluation","info")+makeResultHtml(result,"execerror","error")+makeResultHtml(result,"evaluationerror","error");html||(html=makeResultHtml(result,"execution","error")),$display[html?"show":"hide"](),$display.html(html)}return{setup:function(questionId,userId,aceTheme,textareaName,vplVersion){var $textarea=$('textarea[name="'+textareaName+'"]');console.log("TEXTAREANAME"),console.log(textareaName);var $resetAndCorrectionButtons=$("#qvpl_reset_q"+questionId+", #qvpl_correction_q"+questionId);CodeEditors.setupQuestionEditor(aceTheme,$textarea,$resetAndCorrectionButtons,$textarea.data("lineoffset"),(function(){"readonly"!=$textarea.attr("readonly")&&ScriptsLoader.loadVPLTerminal(vplVersion,(function(){var oldPrototype=Terminal.prototype;Terminal=function(data){return data.rows=10,new oldPrototype.constructor(data)},Terminal.prototype=oldPrototype;var wrapperId="terminal_wrapper_q"+questionId,terminal=new VPLTerminal(wrapperId,wrapperId,str);$("#"+wrapperId).dialog("option","draggable",!1),terminal.setMessage=function(){};var qvplButtons="#qvpl_buttons_q"+questionId,$globalTerminalWrapper=$("#"+wrapperId).parent();$globalTerminalWrapper.insertAfter(qvplButtons);var oldConnect=terminal.connect;terminal.connect=function(){oldConnect.apply(terminal,arguments),$globalTerminalWrapper.css("top",0).css("left",0),$("body > .ui-widget-overlay.ui-front").first().remove()},$globalTerminalWrapper.find(".ui-dialog-titlebar-close").html('<i class="fa fa-close"></i>').addClass("btn btn-secondary close-terminal");var setupButton=function(action,icon,filestype){var $button=$(qvplButtons+' button[data-action="'+action+'"]'),$icon=$('<i class="fa fa-'+icon+'"></i>');$('<span class="ml-2">').append($icon).appendTo($button);var reenableButtons=function(){$icon.attr("class","fa fa-"+icon),$(".qvpl-buttons *").removeAttr("disabled")};$button.click((function(){$(".qvpl-buttons *").attr("disabled","disabled"),$(".close-terminal").trigger("click"),$icon.attr("class","fa fa-refresh fa-spin"),VPLService.call("save",questionId,$textarea.val(),filestype).then((function(){return VPLService.call("exec",action,questionId,userId,terminal,(function(result){displayResult("vpl_result_q"+questionId,result),reenableButtons()}))})).fail((function(details){displayResult("vpl_result_q"+questionId,{execerror:details}),reenableButtons()}))}))};setupButton("run","rocket","run"),setupButton("debug","check-square-o","precheck"),setupButton("evaluate","check-square-o","precheck")}))}))},displayResult:displayResult}}));

//# sourceMappingURL=studentanswer.min.js.map